<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopstepX 當沖交易戰情室</title>
    
    <!-- 1. 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 2. 引入 Babel 用來在瀏覽器編譯 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        body { background-color: #020617; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 圖標組件 (SVG) ---
        const IconWrapper = ({ children, color = "currentColor", size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const LineChart = (props) => <IconWrapper {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconWrapper>;
        const TrendingUp = (props) => <IconWrapper {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></IconWrapper>;
        const DollarSign = (props) => <IconWrapper {...props}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></IconWrapper>;
        const Info = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></IconWrapper>;
        const PlusCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></IconWrapper>;
        const MinusCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></IconWrapper>;
        const Lock = (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const PieChart = (props) => <IconWrapper {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></IconWrapper>;
        const ArrowRight = (props) => <IconWrapper {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconWrapper>;

        // --- Helper: 格式化數值 ---
        const formatNumber = (val) => {
            if (val === null || val === '' || isNaN(val)) return '--';
            const num = parseFloat(val);
            return Number.isInteger(num) ? num.toString() : num.toFixed(2);
        };

        const formatTWD = (val) => {
            if (!val) return '$0';
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(val);
        };

        // --- 元件：技術分析圖形卡片 ---
        const PatternCard = ({ title, svgContent, inputs, resultLabel, resultValue }) => (
            <div className="bg-slate-800 rounded-lg border border-slate-700 p-3 shadow-lg flex flex-col h-full">
                <div className="flex flex-col items-center justify-center bg-slate-900 rounded p-2 border border-slate-800 mb-3">
                    <h3 className="text-sm font-bold text-slate-200 mb-1">{title}</h3>
                    <div className="w-full h-20 flex items-center justify-center">{svgContent}</div>
                </div>
                <div className="flex-1 flex flex-col justify-between space-y-2">
                    <div className="space-y-2">
                        {inputs.map((input, idx) => (
                            <div key={idx} className="flex flex-col">
                                <label className="text-[10px] text-slate-400 mb-0.5">{input.label}</label>
                                <input type="number" value={input.value} onChange={(e) => input.onChange(e.target.value)} className="w-full bg-slate-700 text-white text-sm border border-slate-600 rounded px-2 py-1 focus:outline-none focus:border-blue-500 transition-colors" />
                            </div>
                        ))}
                    </div>
                    <div className="pt-2 border-t border-slate-700 mt-2">
                        <div className="flex flex-col items-center bg-blue-900/20 p-2 rounded border border-blue-500/20">
                            <span className="text-[10px] text-blue-300 font-medium mb-1">{resultLabel}</span>
                            <span className="text-lg font-bold text-white">{formatNumber(resultValue)}</span>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- 元件：回檔/反彈計算卡片 ---
        const FibCard = ({ title, svgContent, inputs, levels }) => (
            <div className="bg-slate-800 rounded-lg border border-slate-700 p-3 shadow-lg flex flex-col h-full">
                <div className="flex flex-col items-center justify-center bg-slate-900 rounded p-2 border border-slate-800 mb-3">
                    <h3 className="text-sm font-bold text-slate-200 mb-1">{title}</h3>
                    <div className="w-full h-20 flex items-center justify-center">{svgContent}</div>
                </div>
                <div className="flex-1 flex flex-col justify-between space-y-2">
                    <div className="space-y-2">
                        {inputs.map((input, idx) => (
                            <div key={idx} className="flex flex-col">
                                <label className="text-[10px] text-slate-400 mb-0.5">{input.label}</label>
                                <input type="number" value={input.value} onChange={(e) => input.onChange(e.target.value)} className="w-full bg-slate-700 text-white text-sm border border-slate-600 rounded px-2 py-1 focus:outline-none focus:border-blue-500 transition-colors" />
                            </div>
                        ))}
                    </div>
                    <div className="pt-2 border-t border-slate-700 mt-2 space-y-1">
                        <div className="text-[10px] text-center text-slate-500 mb-1">關鍵價位 (Key Levels)</div>
                        {levels.map((lvl, idx) => (
                            <div key={idx} className={`flex justify-between items-center px-2 py-1 rounded border ${lvl.highlight ? 'bg-yellow-900/20 border-yellow-500/30' : 'bg-slate-900/40 border-slate-700/50'}`}>
                                <span className={`text-[10px] truncate pr-2 ${lvl.highlight ? 'text-yellow-400 font-bold' : 'text-slate-400'}`}>{lvl.label}</span>
                                <span className={`text-sm font-bold whitespace-nowrap ${lvl.highlight ? 'text-yellow-200' : 'text-slate-200'}`}>{formatNumber(lvl.value)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        // --- 元件：MNQ 加減碼 ---
        const PositionManager = () => {
            const [currentLots, setCurrentLots] = useState('');
            const [currentCost, setCurrentCost] = useState('');
            const [actionLots, setActionLots] = useState('');
            const [actionPrice, setActionPrice] = useState('');
            const [mode, setMode] = useState('add');
            const [newAvgCost, setNewAvgCost] = useState(null);
            const [realizedPnL, setRealizedPnL] = useState(null);
            const POINT_VALUE = 2;

            useEffect(() => {
                if (!currentLots || !currentCost || !actionLots || !actionPrice) {
                    setNewAvgCost(null); setRealizedPnL(null); return;
                }
                const cLots = parseFloat(currentLots); const cCost = parseFloat(currentCost);
                const aLots = parseFloat(actionLots); const aPrice = parseFloat(actionPrice);
                if (mode === 'add') {
                    setNewAvgCost(((cLots * cCost) + (aLots * aPrice)) / (cLots + aLots));
                } else {
                    setRealizedPnL((aPrice - cCost) * aLots * POINT_VALUE);
                }
            }, [currentLots, currentCost, actionLots, actionPrice, mode]);

            return (
                <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg relative mt-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center relative z-10"><TrendingUp className="mr-2 text-orange-400" /> Step 2: 加/減碼 成本試算</h3>
                    <div className="flex space-x-4 mb-4 relative z-10">
                        <button onClick={() => setMode('add')} className={`flex-1 py-2 rounded flex items-center justify-center transition-all ${mode === 'add' ? 'bg-orange-600 text-white' : 'bg-slate-700 text-slate-400'}`}><PlusCircle size={16} className="mr-2" /> 加碼</button>
                        <button onClick={() => setMode('reduce')} className={`flex-1 py-2 rounded flex items-center justify-center transition-all ${mode === 'reduce' ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-400'}`}><MinusCircle size={16} className="mr-2" /> 減碼</button>
                    </div>
                    <div className="grid grid-cols-2 gap-4 relative z-10">
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-700">
                            <h4 className="text-xs text-slate-500 mb-2 uppercase font-bold">目前持倉</h4>
                            <div className="space-y-2">
                                <input type="number" placeholder="目前口數" value={currentLots} onChange={e => setCurrentLots(e.target.value)} className="w-full bg-slate-800 border-slate-600 rounded px-2 py-1 text-white text-sm" />
                                <input type="number" placeholder="目前成本" value={currentCost} onChange={e => setCurrentCost(e.target.value)} className="w-full bg-slate-800 border-slate-600 rounded px-2 py-1 text-white text-sm" />
                            </div>
                        </div>
                        <div className={`bg-slate-900/50 p-3 rounded border border-slate-700 ${mode === 'add' ? 'border-orange-500/30' : 'border-indigo-500/30'}`}>
                            <h4 className="text-xs text-slate-500 mb-2 uppercase font-bold">{mode === 'add' ? '加碼進場' : '部分出場'}</h4>
                            <div className="space-y-2">
                                <input type="number" placeholder={mode === 'add' ? '加碼口數' : '賣出口數'} value={actionLots} onChange={e => setActionLots(e.target.value)} className="w-full bg-slate-800 border-slate-600 rounded px-2 py-1 text-white text-sm" />
                                <input type="number" placeholder={mode === 'add' ? '加碼價格' : '賣出價格'} value={actionPrice} onChange={e => setActionPrice(e.target.value)} className="w-full bg-slate-800 border-slate-600 rounded px-2 py-1 text-white text-sm" />
                            </div>
                        </div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-slate-700 relative z-10">
                        {mode === 'add' ? (
                            <div className="flex justify-between items-center bg-orange-900/20 p-3 rounded border border-orange-500/30"><span className="text-sm text-orange-200">新平均成本</span><span className="text-2xl font-bold text-orange-400">{formatNumber(newAvgCost)}</span></div>
                        ) : (
                            <div className="flex justify-between items-center bg-indigo-900/20 p-3 rounded border border-indigo-500/30"><span className="text-sm text-indigo-200">實現損益</span><span className={`text-2xl font-bold ${realizedPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>{realizedPnL !== null ? (realizedPnL >= 0 ? `+$${formatNumber(realizedPnL)}` : `-$${formatNumber(Math.abs(realizedPnL))}`) : '--'}</span></div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 元件：MNQ 計算器 ---
        const MNQCalculator = () => {
            const [contracts, setContracts] = useState('');
            const [costPrice, setCostPrice] = useState('');
            const [targetPrice, setTargetPrice] = useState('');
            const [calcProfit, setCalcProfit] = useState(null);
            const [costPriceReverse, setCostPriceReverse] = useState('');
            const [desiredProfit, setDesiredProfit] = useState('');
            const [calcTarget, setCalcTarget] = useState(null);
            const POINT_VALUE = 2;

            useEffect(() => {
                if (costPrice && targetPrice && contracts) setCalcProfit((parseFloat(targetPrice) - parseFloat(costPrice)) * parseFloat(contracts) * POINT_VALUE);
                else setCalcProfit(null);
            }, [costPrice, targetPrice, contracts]);

            useEffect(() => {
                if (costPriceReverse && desiredProfit && contracts) {
                    const totalPointValue = parseFloat(contracts) * POINT_VALUE;
                    if (totalPointValue > 0) setCalcTarget(parseFloat(costPriceReverse) + (parseFloat(desiredProfit) / totalPointValue));
                } else setCalcTarget(null);
            }, [costPriceReverse, desiredProfit, contracts]);

            return (
                <div className="space-y-6">
                    <div className="bg-yellow-900/20 border border-yellow-700/50 p-4 rounded-lg flex items-start space-x-3">
                        <Info className="text-yellow-500 w-5 h-5 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-yellow-200 font-bold">MNQ 參數：1 點 = $2 USD</div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                            <h3 className="text-sm font-bold text-green-400 mb-3">Step 1: 基礎設定</h3>
                            <input type="number" value={contracts} onChange={(e) => setContracts(e.target.value)} className="w-full bg-slate-700 text-white text-lg font-bold border border-slate-600 rounded px-3 py-2" placeholder="口數 (Lots)" />
                            <div className="mt-2 text-xs text-slate-400">1 點波動 = <span className="text-green-400 font-bold">${contracts ? (parseFloat(contracts) * POINT_VALUE).toFixed(1) : 0}</span></div>
                        </div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                            <h3 className="text-sm font-bold text-blue-400 mb-3">獲利試算</h3>
                            <div className="flex gap-2"><input type="number" value={costPrice} onChange={(e) => setCostPrice(e.target.value)} className="w-1/2 bg-slate-700 border-slate-600 rounded px-2 py-1 text-white text-sm" placeholder="成本" /><input type="number" value={targetPrice} onChange={(e) => setTargetPrice(e.target.value)} className="w-1/2 bg-slate-700 border-slate-600 rounded px-2 py-1 text-white text-sm" placeholder="出場" /></div>
                            <div className="mt-2 text-right text-lg font-bold text-slate-200">{calcProfit ? `$${formatNumber(calcProfit)}` : '--'}</div>
                        </div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                            <h3 className="text-sm font-bold text-purple-400 mb-3">目標反推</h3>
                            <div className="flex gap-2"><input type="number" value={costPriceReverse} onChange={(e) => setCostPriceReverse(e.target.value)} className="w-1/2 bg-slate-700 border-slate-600 rounded px-2 py-1 text-white text-sm" placeholder="成本" /><input type="number" value={desiredProfit} onChange={(e) => setDesiredProfit(e.target.value)} className="w-1/2 bg-slate-700 border-slate-600 rounded px-2 py-1 text-white text-sm" placeholder="想賺$" /></div>
                            <div className="mt-2 text-right text-lg font-bold text-slate-200">{calcTarget ? formatNumber(calcTarget) : '--'}</div>
                        </div>
                    </div>
                    <PositionManager />
                </div>
            );
        };

        // --- 元件：投資紀錄簿 ---
        const InvestmentJournal = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [records, setRecords] = useState([]);
            const [activeForm, setActiveForm] = useState('cost');
            const [date, setDate] = useState('');
            const [date2, setDate2] = useState('');
            const [accountType, setAccountType] = useState('Topstep 考試帳號');
            const [amount, setAmount] = useState('');

            useEffect(() => {
                const saved = localStorage.getItem('trading_journal_v2');
                if (saved) setRecords(JSON.parse(saved));
            }, []);

            useEffect(() => { localStorage.setItem('trading_journal_v2', JSON.stringify(records)); }, [records]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (password === '8259') setIsAuthenticated(true); else alert('密碼錯誤');
            };

            const addRecord = () => {
                if (!amount || !date) return;
                setRecords([{ id: Date.now(), type: activeForm, date, date2: activeForm === 'withdraw' ? date2 : null, accountType: activeForm === 'cost' ? accountType : null, amount: parseFloat(amount) }, ...records]);
                setAmount(''); setDate(''); setDate2('');
            };

            const stats = useMemo(() => {
                let cost = 0, withdraw = 0;
                records.forEach(r => r.type === 'cost' ? cost += r.amount : withdraw += r.amount);
                return { cost, withdraw, net: withdraw - cost, roi: cost > 0 ? ((withdraw - cost) / cost) * 100 : (withdraw > 0 ? 100 : 0) };
            }, [records]);

            if (!isAuthenticated) return (
                <div className="flex flex-col items-center justify-center h-[50vh]"><div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-2xl flex flex-col items-center"><div className="bg-slate-900 p-4 rounded-full mb-4 border border-slate-700"><Lock className="w-8 h-8 text-blue-500" /></div><h3 className="text-xl font-bold text-white mb-2">解鎖紀錄簿</h3><form onSubmit={handleLogin} className="flex gap-2"><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white" autoFocus /><button type="submit" className="bg-blue-600 px-4 py-2 rounded text-white"><ArrowRight size={20} /></button></form></div></div>
            );

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-xs text-slate-400">總投入成本</p><p className="text-xl font-bold">{formatTWD(stats.cost)}</p></div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-xs text-slate-400">總獲利出金</p><p className="text-xl font-bold text-green-400">{formatTWD(stats.withdraw)}</p></div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-xs text-slate-400">淨損益</p><p className={`text-xl font-bold ${stats.net >= 0 ? 'text-blue-400' : 'text-red-400'}`}>{formatTWD(stats.net)}</p></div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-xs text-slate-400">ROI</p><p className="text-xl font-bold text-purple-400">{stats.roi.toFixed(1)}%</p></div>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div className="flex flex-col"><label className="text-xs text-slate-400 mb-1">{activeForm === 'cost' ? '購買日期' : '申請日期'}</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm" /></div>
                        {activeForm === 'cost' ? <div className="flex flex-col"><label className="text-xs text-slate-400 mb-1">帳戶型態</label><select value={accountType} onChange={e => setAccountType(e.target.value)} className="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm"><option>Topstep 考試帳號</option><option>Topstep 真實帳號</option><option>其他平台費用</option></select></div> : <div className="flex flex-col"><label className="text-xs text-slate-400 mb-1">入帳日期</label><input type="date" value={date2} onChange={e => setDate2(e.target.value)} className="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm" /></div>}
                        <div className="flex flex-col"><label className="text-xs text-slate-400 mb-1">金額 (TWD)</label><input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm" /></div>
                        <div className="flex gap-2"><button onClick={() => setActiveForm('cost')} className={`flex-1 h-10 rounded text-xs font-bold ${activeForm === 'cost' ? 'bg-red-600' : 'bg-slate-700'}`}>投入</button><button onClick={() => setActiveForm('withdraw')} className={`flex-1 h-10 rounded text-xs font-bold ${activeForm === 'withdraw' ? 'bg-green-600' : 'bg-slate-700'}`}>出金</button><button onClick={addRecord} className="w-10 h-10 bg-blue-600 rounded flex items-center justify-center"><PlusCircle size={20} /></button></div>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4 overflow-x-auto">
                        <table className="w-full text-sm text-left"><thead className="text-xs text-slate-500 uppercase bg-slate-900/50"><tr><th className="px-4 py-2">日期</th><th className="px-4 py-2">說明</th><th className="px-4 py-2 text-right">金額</th><th className="px-4 py-2 text-center">刪除</th></tr></thead><tbody className="divide-y divide-slate-700">{records.map(r => (<tr key={r.id} className="hover:bg-slate-700/50"><td className="px-4 py-2">{r.date}</td><td className="px-4 py-2 text-slate-400">{r.type === 'cost' ? r.accountType : `入帳: ${r.date2 || '處理中'}`}</td><td className={`px-4 py-2 text-right font-mono ${r.type === 'cost' ? 'text-red-400' : 'text-green-400'}`}>{r.type === 'cost' ? '-' : '+'}{formatNumber(r.amount)}</td><td className="px-4 py-2 text-center"><button onClick={() => setRecords(records.filter(x => x.id !== r.id))} className="text-slate-600 hover:text-red-400"><Trash2 size={14} /></button></td></tr>))}</tbody></table>
                    </div>
                </div>
            );
        };

        // --- 主程式 ---
        const TradingAssistant = () => {
            const [activeTab, setActiveTab] = useState('tech');

            // --- 測幅狀態 ---
            const [hsHigh, setHsHigh] = useState(''); const [hsNeck, setHsNeck] = useState('');
            const hsTarget = (hsHigh && hsNeck) ? parseFloat(hsNeck) - (parseFloat(hsHigh) - parseFloat(hsNeck)) : null;
            const [wLow, setWLow] = useState(''); const [wNeck, setWNeck] = useState('');
            const wTarget = (wLow && wNeck) ? parseFloat(wNeck) + (parseFloat(wNeck) - parseFloat(wLow)) : null;
            const [nLow1, setNLow1] = useState(''); const [nHigh1, setNHigh1] = useState(''); const [nLow2, setNLow2] = useState('');
            const nTarget = (nLow1 && nHigh1 && nLow2) ? parseFloat(nLow2) + (parseFloat(nHigh1) - parseFloat(nLow1)) : null;
            const [rnHigh1, setRnHigh1] = useState(''); const [rnLow1, setRnLow1] = useState(''); const [rnHigh2, setRnHigh2] = useState('');
            const rnTarget = (rnHigh1 && rnLow1 && rnHigh2) ? parseFloat(rnHigh2) - (parseFloat(rnHigh1) - parseFloat(rnLow1)) : null;

            // --- 回檔狀態 ---
            const [fbL, setFbL] = useState(''); const [fbH, setFbH] = useState('');
            const bR = (fbH && fbL) ? parseFloat(fbH) - parseFloat(fbL) : 0;
            const bLevels = bR > 0 ? [
                { label: '0.382 弱勢回檔 (支撐強)', value: parseFloat(fbH) - (bR * 0.382), highlight: true },
                { label: '0.500 中關', value: parseFloat(fbH) - (bR * 0.5), highlight: false },
                { label: '0.618 強勢回檔 (支撐弱)', value: parseFloat(fbH) - (bR * 0.618), highlight: true }
            ] : [{ label: '0.382', value: null }, { label: '0.500', value: null }, { label: '0.618', value: null }];

            // --- 反彈狀態 ---
            const [frH, setFrH] = useState(''); const [frL, setFrL] = useState('');
            const rR = (frH && frL) ? parseFloat(frH) - parseFloat(frL) : 0;
            const rLevels = rR > 0 ? [
                { label: '0.618 強勢反彈 (有望反轉)', value: parseFloat(frL) + (rR * 0.618), highlight: true },
                { label: '0.500 中關', value: parseFloat(frL) + (rR * 0.5), highlight: false },
                { label: '0.382 弱勢反彈 (容易續跌)', value: parseFloat(frL) + (rR * 0.382), highlight: true }
            ] : [{ label: '0.618', value: null }, { label: '0.500', value: null }, { label: '0.382', value: null }];

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 p-4 font-sans">
                    <div className="max-w-[1200px] mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-slate-800 pb-4">
                            <div><h1 className="text-2xl font-bold text-white">TopstepX 當沖交易戰情室</h1><p className="text-xs text-slate-500">當沖輔助工具 v3.4</p></div>
                            <div className="flex bg-slate-900 p-1 rounded-lg mt-3 md:mt-0 border border-slate-800">
                                <button onClick={() => setActiveTab('tech')} className={`px-4 py-1.5 text-sm rounded-md flex items-center ${activeTab === 'tech' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}><LineChart className="w-3 h-3 mr-2" /> 測幅圖形</button>
                                <button onClick={() => setActiveTab('mnq')} className={`px-4 py-1.5 text-sm rounded-md flex items-center ${activeTab === 'mnq' ? 'bg-green-600 text-white' : 'text-slate-400 hover:text-white'}`}><DollarSign className="w-3 h-3 mr-2" /> 損益算盤</button>
                                <button onClick={() => setActiveTab('journal')} className={`px-4 py-1.5 text-sm rounded-md flex items-center ${activeTab === 'journal' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}`}><PieChart className="w-3 h-3 mr-2" /> 投資紀錄</button>
                            </div>
                        </div>

                        {activeTab === 'tech' && (
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                <PatternCard title="頭肩頂 (空)" resultLabel="滿足點" resultValue={hsTarget} inputs={[{ label: "頭部高點", value: hsHigh, onChange: setHsHigh },{ label: "頸線位置", value: hsNeck, onChange: setHsNeck }]} svgContent={<svg viewBox="0 0 200 100" className="w-full h-full stroke-red-400 stroke-2 fill-none"><path d="M10,80 L40,50 L60,80 L100,20 L140,80 L160,50 L190,80" /><line x1="10" y1="80" x2="190" y2="80" className="stroke-slate-700 stroke-1 stroke-dasharray-4" /></svg>} />
                                <PatternCard title="W 底 (多)" resultLabel="滿足點" resultValue={wTarget} inputs={[{ label: "底部低點", value: wLow, onChange: setWLow },{ label: "頸線高點", value: wNeck, onChange: setWNeck }]} svgContent={<svg viewBox="0 0 200 100" className="w-full h-full stroke-green-400 stroke-2 fill-none"><path d="M10,20 L40,80 L100,40 L160,80 L190,20" /><line x1="10" y1="40" x2="190" y2="40" className="stroke-slate-700 stroke-1 stroke-dasharray-4" /></svg>} />
                                <PatternCard title="N 字 (多)" resultLabel="滿足點" resultValue={nTarget} inputs={[{ label: "起漲點", value: nLow1, onChange: setNLow1 },{ label: "波段高", value: nHigh1, onChange: setNHigh1 },{ label: "回調低", value: nLow2, onChange: setNLow2 }]} svgContent={<svg viewBox="0 0 200 100" className="w-full h-full stroke-blue-400 stroke-2 fill-none"><path d="M10,80 L80,20 L120,60 L190,0" /></svg>} />
                                <PatternCard title="倒 N 字 (空)" resultLabel="滿足點" resultValue={rnTarget} inputs={[{ label: "起跌點", value: rnHigh1, onChange: setRnHigh1 },{ label: "波段低", value: rnLow1, onChange: setRnLow1 },{ label: "反彈高", value: rnHigh2, onChange: setRnHigh2 }]} svgContent={<svg viewBox="0 0 200 100" className="w-full h-full stroke-red-400 stroke-2 fill-none"><path d="M10,20 L80,80 L120,40 L190,100" /></svg>} />
                                
                                <FibCard 
                                    title="回檔計算 (找支撐)" 
                                    inputs={[{ label: "波段起點 (Low)", value: fbL, onChange: setFbL },{ label: "波段終點 (High)", value: fbH, onChange: setFbH }]}
                                    levels={bLevels}
                                    svgContent={<svg viewBox="0 0 200 100" className="w-full h-full fill-none"><path d="M10,90 L100,10 L140,40 L190,15" className="stroke-green-400 stroke-2" /><line x1="100" y1="10" x2="190" y2="10" className="stroke-slate-700 stroke-1 stroke-dasharray-2" /><line x1="100" y1="40" x2="190" y2="40" className="stroke-yellow-500 stroke-1 stroke-dasharray-2" /><circle cx="140" cy="40" r="8" className="stroke-yellow-500 stroke-1" /><text x="140" y="43" className="fill-yellow-500 text-[7px] font-bold" textAnchor="middle">0.382</text></svg>}
                                />

                                <FibCard 
                                    title="反彈計算 (找壓力)" 
                                    inputs={[{ label: "波段起點 (High)", value: frH, onChange: setFrH },{ label: "波段終點 (Low)", value: frL, onChange: setFrL }]}
                                    levels={rLevels}
                                    svgContent={<svg viewBox="0 0 200 100" className="w-full h-full fill-none"><path d="M10,10 L100,90 L140,60 L190,85" className="stroke-red-400 stroke-2" /><line x1="100" y1="90" x2="190" y2="90" className="stroke-slate-700 stroke-1 stroke-dasharray-2" /><line x1="100" y1="60" x2="190" y2="60" className="stroke-yellow-500 stroke-1 stroke-dasharray-2" /><circle cx="140" cy="60" r="8" className="stroke-yellow-500 stroke-1" /><text x="140" y="63" className="fill-yellow-500 text-[7px] font-bold" textAnchor="middle">0.382</text></svg>}
                                />
                            </div>
                        )}
                        {activeTab === 'mnq' && <MNQCalculator />}
                        {activeTab === 'journal' && <InvestmentJournal />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingAssistant />);
    </script>
</body>
</html>