<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopstepX 當沖交易戰情室</title>
    
    <!-- 1. 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 2. 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 4. 引入 Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- 請將下方的內容替換為您在 Firebase 後台取得的 Config ---
        const firebaseConfig = {
        apiKey: "AIzaSyAtcxHLphNwIWxcQ_7EP-wxJDmk1pVgMYI",
  		authDomain: "trading-station-7cdbd.firebaseapp.com",
  		projectId: "trading-station-7cdbd",
  		storageBucket: "trading-station-7cdbd.firebasestorage.app",
  		messagingSenderId: "574547874669",
  		appId: "1:574547874669:web:018583e4a775c647b9c064",
  		measurementId: "G-F1ZEBQMFG4"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "trading-v4-app"; // 固定 ID 用於 Firestore 路徑

        // 將 Firebase 實例掛載到 window 供 React 使用
        window.FB_DB = db;
        window.FB_AUTH = auth;
        window.FB_APP_ID = appId;
        window.FB_METHODS = { collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, signInAnonymously, onAuthStateChanged };
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        body { background-color: #020617; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(51, 65, 85, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 圖標組件 (省略重複部分，保持代碼精簡) ---
        const IconWrapper = ({ children, color = "currentColor", size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const LineChart = (props) => <IconWrapper {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconWrapper>;
        const DollarSign = (props) => <IconWrapper {...props}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></IconWrapper>;
        const Lock = (props) => <IconWrapper {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></IconWrapper>;
        const PieChart = (props) => <IconWrapper {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></IconWrapper>;
        const Edit2 = (props) => <IconWrapper {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></IconWrapper>;
        const CheckCircle = (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconWrapper>;
        const Target = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></IconWrapper>;
        const List = (props) => <IconWrapper {...props}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line></IconWrapper>;
        const BarChart2 = (props) => <IconWrapper {...props}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></IconWrapper>;
        const PiggyBank = (props) => <IconWrapper {...props}><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2.5V5z"></path></IconWrapper>;
        const ArrowRight = (props) => <IconWrapper {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconWrapper>;

        const formatTWD = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val || 0);
        const formatUSD = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);

        // --- 核心邏輯：InvestmentJournal (雲端版) ---
        const InvestmentJournal = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [records, setRecords] = useState([]);
            const [user, setUser] = useState(null);
            const [subTab, setSubTab] = useState('entries');

            // 遵守 RULE 3: 登入流程
            useEffect(() => {
                const { FB_AUTH, FB_METHODS } = window;
                if (!FB_AUTH) return;

                FB_METHODS.signInAnonymously(FB_AUTH).catch(console.error);
                const unsubscribe = FB_METHODS.onAuthStateChanged(FB_AUTH, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 遵守 RULE 1: 資料讀取 (Real-time)
            useEffect(() => {
                const { FB_DB, FB_METHODS, FB_APP_ID } = window;
                if (!user || !FB_DB) return;

                // 修正路徑以符合安全性規則
                const q = FB_METHODS.query(FB_METHODS.collection(FB_DB, 'artifacts', FB_APP_ID, 'public', 'data', 'journal'));
                
                const unsubscribe = FB_METHODS.onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRecords(data);
                }, (error) => {
                    console.error("Firestore Error:", error);
                });

                return () => unsubscribe();
            }, [user]);

            const handleAdd = async (newRecord) => {
                const { FB_DB, FB_METHODS, FB_APP_ID } = window;
                if (!user) return;
                await FB_METHODS.addDoc(FB_METHODS.collection(FB_DB, 'artifacts', FB_APP_ID, 'public', 'data', 'journal'), newRecord);
            };

            const handleUpdate = async (id, updatedData) => {
                const { FB_DB, FB_METHODS, FB_APP_ID } = window;
                const docRef = FB_METHODS.doc(FB_DB, 'artifacts', FB_APP_ID, 'public', 'data', 'journal', id);
                await FB_METHODS.updateDoc(docRef, updatedData);
            };

            const handleDelete = async (id) => {
                if (!window.confirm('確定刪除？')) return;
                const { FB_DB, FB_METHODS, FB_APP_ID } = window;
                const docRef = FB_METHODS.doc(FB_DB, 'artifacts', FB_APP_ID, 'public', 'data', 'journal', id);
                await FB_METHODS.deleteDoc(docRef);
            };

            if (!isAuthenticated) return (
                <div className="flex flex-col items-center justify-center h-[50vh]">
                    <div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-2xl flex flex-col items-center">
                        <div className="bg-slate-900 p-4 rounded-full mb-4 border border-slate-700"><Lock className="w-8 h-8 text-blue-500" /></div>
                        <h3 className="text-xl font-bold text-white mb-2">解鎖雲端紀錄簿</h3>
                        <form onSubmit={(e) => { e.preventDefault(); if(password === '8259') setIsAuthenticated(true); else alert('密碼錯誤'); }} className="flex gap-2">
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white" autoFocus />
                            <button type="submit" className="bg-blue-600 px-4 py-2 rounded text-white"><ArrowRight size={20} /></button>
                        </form>
                        <p className="mt-4 text-[10px] text-slate-500">{user ? '● 雲端連線已就緒' : '○ 正在連接資料庫...'}</p>
                    </div>
                </div>
            );

            return (
                <div className="space-y-6">
                    <div className="flex space-x-2 border-b border-slate-800 pb-2">
                         <button onClick={() => setSubTab('entries')} className={`px-4 py-2 rounded-t-lg text-sm font-bold flex items-center ${subTab === 'entries' ? 'bg-slate-800 text-white' : 'text-slate-400'}`}><List size={14} className="mr-2"/> 帳務明細</button>
                         <button onClick={() => setSubTab('analysis')} className={`px-4 py-2 rounded-t-lg text-sm font-bold flex items-center ${subTab === 'analysis' ? 'bg-slate-800 text-white' : 'text-slate-400'}`}><BarChart2 size={14} className="mr-2"/> 成效分析</button>
                    </div>
                    {subTab === 'entries' ? 
                        <JournalEntries records={records} onAdd={handleAdd} onUpdate={handleUpdate} onDelete={handleDelete} /> : 
                        <JournalAnalysis records={records} />
                    }
                </div>
            );
        };

        // --- 帳務明細元件 (簡化版供示範) ---
        const JournalEntries = ({ records, onAdd, onUpdate, onDelete }) => {
            const [date, setDate] = useState('');
            const [amount, setAmount] = useState('');

            const sorted = useMemo(() => [...records].sort((a,b) => new Date(b.date) - new Date(a.date)), [records]);

            return (
                <div className="space-y-4">
                    <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 grid grid-cols-3 gap-4 items-end">
                        <div><label className="text-xs text-slate-500">日期</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-slate-800 rounded p-2 text-sm border border-slate-600"/></div>
                        <div><label className="text-xs text-slate-500">金額 (TWD)</label><input type="number" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full bg-slate-800 rounded p-2 text-sm border border-slate-600"/></div>
                        <button onClick={() => { onAdd({type:'cost', date, amount: parseFloat(amount), accountType:'Topstep 考試帳號'}); setDate(''); setAmount(''); }} className="bg-blue-600 py-2 rounded font-bold text-sm">新增紀錄</button>
                    </div>
                    <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-900 text-slate-500 text-[10px]"><tr><th className="p-3 text-left">日期</th><th className="p-3 text-left">類型</th><th className="p-3 text-right">金額</th><th className="p-3 text-center">操作</th></tr></thead>
                            <tbody className="divide-y divide-slate-700">
                                {sorted.map(r => (
                                    <tr key={r.id} className="hover:bg-slate-700/30">
                                        <td className="p-3">{r.date}</td>
                                        <td className="p-3 text-xs text-slate-400">{r.accountType || '出金'}</td>
                                        <td className="p-3 text-right font-mono">{formatTWD(r.amount)}</td>
                                        <td className="p-3 text-center"><button onClick={()=>onDelete(r.id)} className="text-slate-500 hover:text-red-400"><Trash2 size={14}/></button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const JournalAnalysis = ({ records }) => {
            const total = records.reduce((acc, r) => acc + (r.amount || 0), 0);
            return (
                <div className="bg-slate-800 p-8 rounded-xl border border-slate-700 text-center">
                    <h3 className="text-slate-400 text-sm mb-2">總累計投入</h3>
                    <div className="text-4xl font-bold text-white">{formatTWD(total)}</div>
                </div>
            );
        };

        // --- 主程式：TradingAssistant ---
        const TradingAssistant = () => {
            const [activeTab, setActiveTab] = useState('journal');
            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 p-4 font-sans">
                    <div className="max-w-[1200px] mx-auto">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                            <h1 className="text-xl font-bold text-white">TopstepX 雲端戰情室 <span className="text-[10px] text-blue-500">LIVE</span></h1>
                            <div className="flex bg-slate-900 p-1 rounded-lg border border-slate-800">
                                <button onClick={() => setActiveTab('journal')} className={`px-4 py-1 text-sm rounded ${activeTab === 'journal' ? 'bg-purple-600' : 'text-slate-500'}`}>雲端紀錄</button>
                            </div>
                        </div>
                        {activeTab === 'journal' && <InvestmentJournal />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingAssistant />);
    </script>
</body>
</html>